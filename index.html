<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery & Log (Fast SPA)</title>
  <link rel="stylesheet" href="./index.css" />
</head>

<body>
  <header class="tabbar" role="tablist" aria-label="ビュー切替">
    <!-- タブ順を「ログ → ギャラリー」に逆転、デフォルトはログをアクティブに -->
    <button class="tab is-active" role="tab" aria-selected="true" data-target="time">早朝出勤日一覧</button>
    <button class="tab" role="tab" aria-selected="false" data-target="gallery">川向ギャラリー</button>
  </header>

  <main class="main">
    <!-- ログ（デフォルト表示） -->
    <section id="view-time" class="view is-active" aria-labelledby="tab-time">
      <div class="logbar">
        <span id="log-status" class="time">未取得</span>
      </div>
      <pre id="log" class="logbox" aria-label="log.txt の内容（読み取り専用）"></pre>
    </section>

    <!-- ギャラリー（非表示で開始） -->
    <section id="view-gallery" class="view" aria-labelledby="tab-gallery">
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <script>
    /*** 設定エリア（必要に応じて編集） ****************************/
    const IMAGES = [
      "background.png", "yatai.png", "ramain.png", "sokun.png", "nngk.png"
    ];
    const GALLERY_BASE = "./gallery/";   // 画像の基準パス
    const LOG_URL = "./public/log.txt"; // ログファイル
    const LOG_TTL_MS = 30 * 1000;      // ログキャッシュ 30秒
    /***************************************************************/

    (function initTabs() {
      const tabs = Array.from(document.querySelectorAll('.tabbar .tab'));
      const views = {
        gallery: document.getElementById('view-gallery'),
        time: document.getElementById('view-time'),
      };

      let galleryRendered = false;
      let lastLogText = null;
      let lastLogAt = 0;

      function show(name) {
        // 表示切り替え
        Object.entries(views).forEach(([key, el]) => {
          el.classList.toggle('is-active', key === name);
        });
        // タブの状態更新
        tabs.forEach(btn => {
          const active = btn.dataset.target === name;
          btn.classList.toggle('is-active', active);
          btn.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        // ハッシュ更新
        history.replaceState(null, '', '#' + name);

        // 初回処理
        if (name === 'gallery' && !galleryRendered) {
          renderGallery();
          galleryRendered = true;
        } else if (name === 'time') {
          const now = Date.now();
          if (!lastLogText || now - lastLogAt > LOG_TTL_MS) {
            fetchLog().catch(() => { });
          } else {
            setLog(lastLogText, lastLogAt);
          }
        }
      }

      tabs.forEach(btn => {
        btn.addEventListener('click', () => show(btn.dataset.target));
      });

      // ★ デフォルトは #time （ログ）
      const h = (location.hash || '#time').replace('#', '');
      show(h === 'gallery' ? 'gallery' : 'time');

      // --- ギャラリー描画 ---
      function renderGallery() {
        const grid = document.getElementById('grid');
        if (!IMAGES.length) {
          grid.innerHTML = '<p class="muted">画像が登録されていません（IMAGES 配列に追加してください）。</p>';
          return;
        }
        const frag = document.createDocumentFragment();
        IMAGES.forEach(src => {
          const fig = document.createElement('figure'); fig.className = 'card';
          const frame = document.createElement('div'); frame.className = 'frame';
          const img = document.createElement('img');
          img.loading = 'lazy'; img.decoding = 'async';
          img.src = resolvePath(src);
          img.alt = src.split('/').pop();
          img.onerror = () => { img.alt = '(読み込み失敗) ' + img.alt; };
          frame.appendChild(img);
          fig.appendChild(frame);
          const cap = document.createElement('figcaption'); cap.className = 'caption';
          cap.textContent = img.alt;
          fig.appendChild(cap);
          frag.appendChild(fig);
        });
        grid.appendChild(frag);
      }

      // --- ログ取得 ---
      async function fetchLog(force = false) {
        const status = document.getElementById('log-status');
        status.textContent = '取得中…';
        const res = await fetch(
          LOG_URL + (force ? ('?t=' + Date.now()) : ''),
          { cache: force ? 'no-store' : 'reload' }
        );
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        lastLogText = text;
        lastLogAt = Date.now();
        setLog(text, lastLogAt);
      }

      function setLog(text, ts) {
        const pre = document.getElementById('log');
        pre.textContent = text;
        const status = document.getElementById('log-status');
        const d = new Date(ts);
        status.textContent = `取得: ${d.toLocaleString()}（キャッシュ ${Math.floor(LOG_TTL_MS / 1000)}秒）`;
      }

      function resolvePath(p) {
        if (/^https?:\/\//i.test(p)) return p;
        if (p.startsWith('./') || p.startsWith('../') || p.startsWith('/')) return p;
        return GALLERY_BASE + p;
      }
    })();
  </script>
</body>

</html>

