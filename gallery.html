<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery</title>
  <link rel="stylesheet" href="./index.css" />
</head>

<body>
  <main class="page page--gallery">
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>
  <script>
    // 指定: /gallery/manifest.json に列挙された PNG をすべて表示
    // 想定フォーマット：
    //  1) ["a.png","b.png", ...]
    //  2) { "images": ["a.png","b.png"] }

    const MANIFEST_URL = './gallery/manifest.json';

    function resolvePath(p) {
      // 絶対URL or ルート始まりはそのまま。それ以外は /gallery/ を付与
      if (/^https?:\/\//i.test(p) || p.startsWith('/')) return p;
      return './gallery/' + p;
    }

    async function loadManifest() {
      const u = MANIFEST_URL + '?t=' + Date.now(); // キャッシュ回避
      const res = await fetch(u, { cache: 'no-store' });
      if (!res.ok) throw new Error('manifest の取得に失敗: ' + res.status);
      const data = await res.json();
      const list = Array.isArray(data) ? data : (Array.isArray(data?.images) ? data.images : []);
      return list.filter(Boolean).map(String);
    }

    function createCard(src) {
      const grid = document.getElementById('grid');
      const card = document.createElement('figure');
      card.className = 'card';

      const frame = document.createElement('div');
      frame.className = 'frame';

      const img = document.createElement('img');
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = resolvePath(src);
      img.alt = src.split('/').pop();

      frame.appendChild(img);
      card.appendChild(frame);

      const cap = document.createElement('figcaption');
      cap.className = 'caption';
      cap.textContent = img.alt;
      card.appendChild(cap);

      grid.appendChild(card);
    }

    (async function () {
      const grid = document.getElementById('grid');
      try {
        const items = await loadManifest();
        if (!items.length) {
          grid.innerHTML = '<p class="muted">manifest に画像が見つかりませんでした。</p>';
          return;
        }
        items.forEach(createCard);
      } catch (e) {
        grid.innerHTML = '<p class="error">読み込みエラー: ' + (e?.message || e) + '</p>';
      }
    })();
  </script>
</body>


</html>

